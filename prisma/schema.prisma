generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int        @id @default(autoincrement())
  email        String     @unique @db.VarChar(500)
  name         String     @db.VarChar(500)
  password     String     @db.VarChar(500)
  phoneNumber  String?    @db.VarChar(11)
  avatar       String?    @db.VarChar(1000)
  status       UserStatus @default(INACTIVE)
  premiumCoins Int        @default(0)
  freeCoins    Int        @default(0)
  exp          Int        @default(0)
  eloscore     Int        @default(0)
  levelJLPT    Int? // Cấp độ JLPT của user (3, 4, 5)
  roleId       Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  levelId      Int?
  level        Level?     @relation(fields: [levelId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  createdPermissions         Permission[]        @relation("PermissionCreatedBy")
  updatedPermissions         Permission[]        @relation("PermissionUpdatedBy")
  deletedPermissions         Permission[]        @relation("PermissionDeletedBy")
  createdRoles               Role[]              @relation("RoleCreatedBy")
  updatedRoles               Role[]              @relation("RoleUpdatedBy")
  deletedRoles               Role[]              @relation("RoleDeletedBy")
  createdLevels              Level[]             @relation("LevelCreatedBy")
  updatedLevels              Level[]             @relation("LevelUpdatedBy")
  deletedLevels              Level[]             @relation("LevelDeletedBy")
  createdRewards             Reward[]            @relation("RewardCreatedBy")
  updatedRewards             Reward[]            @relation("RewardUpdatedBy")
  deletedRewards             Reward[]            @relation("RewardDeletedBy")
  createdVocabularies        Vocabulary[]        @relation("VocabularyCreatedBy")
  createdLessons             Lesson[]            @relation("LessonCreatedBy")
  createdPokemons            Pokemon[]           @relation("PokemonCreatedBy")
  updatedPokemons            Pokemon[]           @relation("PokemonUpdatedBy")
  deletedPokemons            Pokemon[]           @relation("PokemonDeletedBy")
  createdElementalTypes      ElementalType[]     @relation("ElementalTypeCreatedBy")
  updatedElementalTypes      ElementalType[]     @relation("ElementalTypeUpdatedBy")
  deletedElementalTypes      ElementalType[]     @relation("ElementalTypeDeletedBy")
  createdTypeEffectivenesses TypeEffectiveness[] @relation("TypeEffectivenessCreatedBy")
  updatedTypeEffectivenesses TypeEffectiveness[] @relation("TypeEffectivenessUpdatedBy")
  deletedTypeEffectivenesses TypeEffectiveness[] @relation("TypeEffectivenessDeletedBy")
  createdDailyRequest        DailyRequest[]      @relation("DailyRequestCreatedBy")
  updatedDailyRequest        DailyRequest[]      @relation("DailyRequestUpdatedBy")
  deletedDailyRequest        DailyRequest[]      @relation("DailyRequestDeletedBy")
  createdUserDailyRequest    UserDailyRequest[]  @relation("UserDailyRequestCreatedBy")
  updatedUserDailyRequest    UserDailyRequest[]  @relation("UserDailyRequestUpdatedBy")
  deletedUserDailyRequest    UserDailyRequest[]  @relation("UserDailyRequestDeletedBy")
  createdAchievements        Achievement[]       @relation("AchievementCreatedBy")
  updatedAchievements        Achievement[]       @relation("AchievementUpdatedBy")
  deletedAchievements        Achievement[]       @relation("AchievementDeletedBy")
  createdAchievementGroups   AchievementGroup[]  @relation("AchievementGroupCreatedBy")
  updatedAchievementGroups   AchievementGroup[]  @relation("AchievementGroupUpdatedBy")
  deletedAchievementGroups   AchievementGroup[]  @relation("AchievementGroupDeletedBy")

  createdQuestionBanks                QuestionBank[]        @relation("QuestionBankCreatedBy")
  createdAttendanceConfigs            AttendanceConfig[]    @relation("AttendanceConfigCreatedBy")
  updatedAttendanceConfigs            AttendanceConfig[]    @relation("AttendanceConfigUpdatedBy")
  deletedAttendanceConfigs            AttendanceConfig[]    @relation("AttendanceConfigDeletedBy")
  createdAttendances                  Attendance[]          @relation("AttendanceCreatedBy")
  updatedAttendances                  Attendance[]          @relation("AttendanceUpdatedBy")
  deletedAttendances                  Attendance[]          @relation("AttendanceDeletedBy")
  createdTestSets                     TestSet[]             @relation("TestSetCreatedBy")
  createdWallets                      Wallet[]              @relation("WalletCreatedBy")
  updatedWallets                      Wallet[]              @relation("WalletUpdatedBy")
  deletedWallets                      Wallet[]              @relation("WalletDeletedBy")
  createdWalletTransactions           WalletTransaction[]   @relation("WalletTransactionCreatedBy")
  updatedWalletTransactions           WalletTransaction[]   @relation("WalletTransactionUpdatedBy")
  deletedWalletTransactions           WalletTransaction[]   @relation("WalletTransactionDeletedBy")
  createdShopBanners                  ShopBanner[]          @relation("ShopBannerCreatedBy")
  updatedShopBanners                  ShopBanner[]          @relation("ShopBannerUpdatedBy")
  deletedShopBanners                  ShopBanner[]          @relation("ShopBannerDeletedBy")
  createdShopPurchases                ShopPurchase[]        @relation("ShopPurchaseCreatedBy")
  updatedShopPurchases                ShopPurchase[]        @relation("ShopPurchaseUpdatedBy")
  deletedShopPurchases                ShopPurchase[]        @relation("ShopPurchaseDeletedBy")
  createdShopItems                    ShopItem[]            @relation("ShopItemCreatedBy")
  updatedShopItems                    ShopItem[]            @relation("ShopItemUpdatedBy")
  deletedShopItems                    ShopItem[]            @relation("ShopItemDeletedBy")
  createdGachaBanners                 GachaBanner[]         @relation("GachaBannerCreatedBy")
  updatedGachaBanners                 GachaBanner[]         @relation("GachaBannerUpdatedBy")
  deletedGachaBanners                 GachaBanner[]         @relation("GachaBannerDeletedBy")
  createdGachaItemRates               GachaItemRate[]       @relation("GachaItemRateCreatedBy")
  updatedGachaItemRates               GachaItemRate[]       @relation("GachaItemRateUpdatedBy")
  deletedGachaItemRates               GachaItemRate[]       @relation("GachaItemRateDeletedBy")
  createdGachaItems                   GachaItem[]           @relation("GachaItemCreatedBy")
  updatedGachaItems                   GachaItem[]           @relation("GachaItemUpdatedBy")
  deletedGachaItems                   GachaItem[]           @relation("GachaItemDeletedBy")
  createdGachaPurchases               GachaPurchase[]       @relation("GachaPurchaseCreatedBy")
  updatedGachaPurchases               GachaPurchase[]       @relation("GachaPurchaseUpdatedBy")
  deletedGachaPurchases               GachaPurchase[]       @relation("GachaPurchaseDeletedBy")
  createdShopRarityPrices             ShopRarityPrice[]     @relation("ShopRarityPriceCreatedBy")
  updatedShopRarityPrices             ShopRarityPrice[]     @relation("ShopRarityPriceUpdatedBy")
  deletedShopRarityPrices             ShopRarityPrice[]     @relation("ShopRarityPriceDeletedBy")
  createdLeaderboardSeasons           LeaderboardSeason[]   @relation("LeaderboardSeasonCreatedBy")
  updatedLeaderboardSeasons           LeaderboardSeason[]   @relation("LeaderboardSeasonUpdatedBy")
  deletedLeaderboardSeasons           LeaderboardSeason[]   @relation("LeaderboardSeasonDeletedBy")
  createdDebuffMatchRoundParticipants DebuffRound[]         @relation("DebuffMatchRoundParticipantCreatedBy")
  updatedDebuffMatchRoundParticipants DebuffRound[]         @relation("DebuffMatchRoundParticipantUpdatedBy")
  deletedDebuffMatchRoundParticipants DebuffRound[]         @relation("DebuffMatchRoundParticipantDeletedBy")
  createdGeminiConfigs                GeminiConfig[]        @relation("GeminiConfigCreatedBy")
  updatedGeminiConfigs                GeminiConfig[]        @relation("GeminiConfigUpdatedBy")
  deletedGeminiConfigs                GeminiConfig[]        @relation("GeminiConfigDeletedBy")
  createdseasonRankRewards            SeasonRankReward[]    @relation("SeasonRankRewardCreatedBy")
  updatedSeasonRankRewards            SeasonRankReward[]    @relation("SeasonRankRewardUpdatedBy")
  deletedSeasonRankRewards            SeasonRankReward[]    @relation("SeasonRankRewardDeletedBy")
  createdSubscription                 Subscription[]        @relation("SubscriptionCreatedBy")
  updatedSubscription                 Subscription[]        @relation("SubscriptionUpdatedBy")
  deletedSubscription                 Subscription[]        @relation("SubscriptionDeletedBy")
  createdSubscriptionPlans            SubscriptionPlan[]    @relation("SubscriptionPlanCreatedBy")
  updatedSubscriptionPlans            SubscriptionPlan[]    @relation("SubscriptionPlanUpdatedBy")
  deletedSubscriptionPlans            SubscriptionPlan[]    @relation("SubscriptionPlanDeletedBy")
  createdSubscriptionFeatures         SubscriptionFeature[] @relation("SubscriptionFeatureCreatedBy")
  updatedSubscriptionFeatures         SubscriptionFeature[] @relation("SubscriptionFeatureUpdatedBy")
  deletedSubscriptionFeatures         SubscriptionFeature[] @relation("SubscriptionFeatureDeletedBy")
  createdUserSubscriptions            UserSubscription[]    @relation("UserSubscriptionCreatedBy")
  updatedUserSubscriptions            UserSubscription[]    @relation("UserSubscriptionUpdatedBy")
  deletedUserSubscriptions            UserSubscription[]    @relation("UserSubscriptionDeletedBy")
  createdFeatures                     Feature[]             @relation("FeatureCreatedBy")
  updatedFeatures                     Feature[]             @relation("FeatureUpdatedBy")
  deletedFeatures                     Feature[]             @relation("FeatureDeletedBy")
  processedPayments                   Payment[]             @relation("PaymentProcessedBy")
  // 1 user có thể tạo ra nhiều user khác
  // 1 user chỉ có thể được tạo ra bởi 1 user khác
  // Tự quan hệ 1-n
  devices                             Device[] // Liên kết 1-n với Device
  refreshTokens                       RefreshToken[]
  userDailyRequests                   UserDailyRequest[]
  userPokemons                        UserPokemon[]
  userAchievements                    UserAchievement[]
  userExerciseAttempts                UserExerciseAttempt[]
  userTests                           UserTest[]            @relation("UserTests")
  userTestAttempts                    UserTestAttempt[]     @relation("UserTestAttempts")

  userAIConversations UserAIConversation[]
  userProgresses      UserProgress[]
  attendances         Attendance[]
  Wallet              Wallet[]
  WalletTransaction   WalletTransaction[]
  shopPurchases       ShopPurchase[]
  gachaPurchases      GachaPurchase[]
  gachaRollHistories  GachaRollHistory[]
  userGachaPity       UserGachaPity[]
  matchmakingQueue    MatchQueue?
  matchWins           Match[]              @relation("WonMatches")
  matchParticipants   MatchParticipant[]
  userSeasonHistories UserSeasonHistory[]
  userRewardHistories UserRewardHistory[]

  createdById  Int?
  createdBy    User?  @relation("CreatorUsers", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  createdUsers User[] @relation("CreatorUsers")

  updatedById  Int?
  updatedBy    User?  @relation("UpdatorUsers", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedUsers User[] @relation("UpdatorUsers")
  deletedById  Int?
  deletedBy    User?  @relation("DeletorUsers", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedUsers User[] @relation("DeletorUsers")

  deletedAt                 DateTime?
  createdAt                 DateTime                  @default(now())
  updatedAt                 DateTime                  @updatedAt
  tests                     Test[]                    @relation("TestCreatedBy")
  // Audit backlink for GeminiConfigModel
  createdGeminiConfigModels GeminiConfigModel[]       @relation("GeminiConfigModelCreatedBy")
  updatedGeminiConfigModels GeminiConfigModel[]       @relation("GeminiConfigModelUpdatedBy")
  deletedGeminiConfigModels GeminiConfigModel[]       @relation("GeminiConfigModelDeletedBy")
  UserAIRecommendation      UserAIRecommendation[]
  UserSrsReview             UserSrsReview[]
  aiconversationRooms       AIConversationRoom[]
  userSubscriptions         UserSubscription[]
  flashcardDecks            FlashcardDeck[]
  vocabularySearchHistories VocabularySearchHistory[]
  invoices                  Invoice[]
  payments                  Payment[]

  @@index([deletedAt])
}

model Device {
  id            Int            @id @default(autoincrement())
  userId        Int
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  userAgent     String
  ip            String
  lastActive    DateTime       @updatedAt // Thay updatedAt bằng lastActive cho ý nghĩa rõ hơn
  createdAt     DateTime       @default(now())
  isActive      Boolean        @default(true) // Trạng thái thiết bị (đang login hay đã logout)
  refreshTokens RefreshToken[] // Liên kết 1-n với RefreshToken
}

model RefreshToken {
  token     String   @unique @db.VarChar(1000)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  deviceId  Int // Foreign key tới Device
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
}

model Permission {
  id          Int        @id @default(autoincrement())
  name        String     @db.VarChar(500)
  description String     @default("")
  path        String     @db.VarChar(1000)
  method      HTTPMethod
  module      String     @default("") @db.VarChar(500)
  roles       Role[]

  createdById Int?
  createdBy   User? @relation("PermissionCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("PermissionUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("PermissionDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @db.VarChar(500)
  description String       @default("")
  isActive    Boolean      @default(true)
  permissions Permission[]
  users       User[]

  createdById Int?
  createdBy   User? @relation("RoleCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("RoleUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("RoleDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

// Model Languages (Quản lý các ngôn ngữ được hỗ trợ)
model Languages {
  id   Int    @id @default(autoincrement())
  code String @unique @db.VarChar(10) // Mã ngôn ngữ (vi, en, ja, etc.)
  name String @db.VarChar(100) // Tên ngôn ngữ (Vietnamese, English, Japanese, etc.)

  // Quan hệ với Translation
  translations Translation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

// Model Translation (Hệ thống đa ngôn ngữ tập trung)
model Translation {
  id         Int    @id @default(autoincrement())
  languageId Int // Foreign key đến Languages.id
  key        String @db.VarChar(500) // Key định danh duy nhất
  value      String @db.VarChar(2000) // Nội dung đã dịch

  // Quan hệ với Languages
  language Languages @relation(fields: [languageId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  //translate cho cac table khac
  rewardNameKey String? // tên key của reward
  reward        Reward? @relation(fields: [rewardNameKey], references: [nameKey], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dailyRequestNameKey String?
  dailyRequestName    DailyRequest? @relation("DailyRequestNameRelation", fields: [dailyRequestNameKey], references: [nameKey], onDelete: Cascade)

  dailyRequestDescriptionKey String?
  dailyRequestDescription    DailyRequest? @relation("DailyRequestDescriptionRelation", fields: [dailyRequestDescriptionKey], references: [descriptionKey], onDelete: Cascade)

  shopBannerNameKey String?
  shopBanner        ShopBanner? @relation("ShopBannerNameRelation", fields: [shopBannerNameKey], references: [nameKey], onDelete: Cascade)

  gachaBannerNameKey String?
  gachaBanner        GachaBanner? @relation("GachaBannerNameRelation", fields: [gachaBannerNameKey], references: [nameKey], onDelete: Cascade)

  leaderboardSeasonNameKey String?
  leaderboardSeason        LeaderboardSeason? @relation("LeaderboardSeasonNameRelation", fields: [leaderboardSeasonNameKey], references: [nameKey], onDelete: Cascade)

  debuffRoundNameKey String?
  debuffRound        DebuffRound? @relation("DebuffRoundNameRelation", fields: [debuffRoundNameKey], references: [nameKey], onDelete: Cascade)

  achievementGroupNameKey String?
  achievementGroup        AchievementGroup? @relation("AchievementGroupNameRelation", fields: [achievementGroupNameKey], references: [nameKey], onDelete: Cascade)

  achievementNameKey          String?
  achievement                 Achievement? @relation("AchievementNameRelation", fields: [achievementNameKey], references: [nameKey], onDelete: Cascade)
  achievementDescriptionKey   String?
  achievementDescription      Achievement? @relation("AchievementDescriptionRelation", fields: [achievementDescriptionKey], references: [descriptionKey], onDelete: Cascade)
  achievementConditionTextKey String?
  achievementCondition        Achievement? @relation("AchievementConditionTextRelation", fields: [achievementConditionTextKey], references: [conditionTextKey], onDelete: Cascade)

  subscriptionNameKey        String?
  subscriptionName           Subscription? @relation("SubscriptionNameRelation", fields: [subscriptionNameKey], references: [nameKey], onDelete: Cascade)
  subscriptionDescriptionKey String?
  subscriptionDescription    Subscription? @relation("SubscriptionDescriptionRelation", fields: [subscriptionDescriptionKey], references: [descriptionKey], onDelete: Cascade)

  featureNameKey String?
  feature        Feature? @relation("FeatureNameRelation", fields: [featureNameKey], references: [nameKey], onDelete: Cascade)

  @@unique([languageId, key]) // Cặp (languageId, key) phải duy nhất
  @@index([languageId])
  @@index([key])
}

// Model WordType (Loại từ)
model WordType {
  id           Int          @id @default(autoincrement())
  nameKey      String       @unique @db.VarChar(100) // Key để dịch tên loại từ
  vocabularies Vocabulary[] // Quan hệ Một-Nhiều với Vocabulary
  meanings     Meaning[] // Quan hệ Một-Nhiều với Meaning

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nameKey])
}

// Model Kanji (Thư viện Kanji)
model Kanji {
  id           Int                @id @default(autoincrement())
  character    String             @unique @db.VarChar(10) // Một ký tự Kanji duy nhất
  meaningKey   String             @db.VarChar(200) // Key để dịch nghĩa của Kanji
  strokeCount  Int? // Số nét vẽ
  jlptLevel    Int? // Cấp độ JLPT (1-5)
  img          String?            @db.VarChar(500) // URL hình ảnh của Kanji
  vocabularies Vocabulary_Kanji[] // Quan hệ Nhiều-Nhiều với Vocabulary
  readings     Kanji_Reading[] // Quan hệ Một-Nhiều với Kanji_Reading

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  flashcardCards FlashcardCard[]

  @@index([character])
  @@index([meaningKey])
  @@index([jlptLevel])
}

// Model Kanji_Reading (Cách đọc Kanji)
model Kanji_Reading {
  id          Int    @id @default(autoincrement())
  kanjiId     Int // Khóa ngoại, liên kết đến Kanji
  kanji       Kanji  @relation(fields: [kanjiId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  readingType String @db.VarChar(20) // Loại cách đọc (onyomi, kunyomi, nanori, etc.)
  reading     String @db.VarChar(100) // Cách đọc cụ thể

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kanjiId])
  @@index([readingType])
  @@index([reading])
}

// Model Meaning (Nghĩa của từ)
model Meaning {
  id           Int        @id @default(autoincrement())
  vocabularyId Int // Khóa ngoại, liên kết đến Vocabulary
  vocabulary   Vocabulary @relation(fields: [vocabularyId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  wordTypeId   Int? // Khóa ngoại, liên kết đến WordType
  wordType     WordType?  @relation(fields: [wordTypeId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  // Translation keys
  meaningKey         String? @db.VarChar(500) // Key để dịch nghĩa
  exampleSentenceKey String? @db.VarChar(500) // Key để dịch câu ví dụ
  explanationKey     String? @db.VarChar(500) // Key để dịch giải thích

  exampleSentenceJp String? @db.VarChar(1000) // Câu ví dụ tiếng Nhật

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vocabularyId])
  @@index([wordTypeId])
  @@index([meaningKey])
  @@index([exampleSentenceKey])
  @@index([explanationKey])
}

// Model Vocabulary_Kanji (Bảng nối)
model Vocabulary_Kanji {
  vocabularyId Int // Khóa ngoại, liên kết đến Vocabulary
  vocabulary   Vocabulary @relation(fields: [vocabularyId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  kanjiId      Int // Khóa ngoại, liên kết đến Kanji
  kanji        Kanji      @relation(fields: [kanjiId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  displayOrder Int // Thứ tự xuất hiện của Kanji trong từ vựng

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([vocabularyId, kanjiId])
  @@index([vocabularyId])
  @@index([kanjiId])
}

// Model Vocabulary (Cập nhật)
model Vocabulary {
  id         Int       @id @default(autoincrement())
  wordJp     String    @db.VarChar(500) // Từ vựng viết bằng Kanji
  reading    String    @db.VarChar(500) // Cách đọc bằng Hiragana
  imageUrl   String?   @db.VarChar(1000)
  audioUrl   String?   @db.VarChar(1000)
  levelN     Int? // Cấp độ JLPT của từ
  wordTypeId Int? // Khóa ngoại, liên kết đến WordType
  wordType   WordType? @relation(fields: [wordTypeId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  // Quan hệ với các model mới
  meanings Meaning[] // Quan hệ Một-Nhiều với Meaning
  kanji    Vocabulary_Kanji[] // Quan hệ Một-Nhiều với bảng nối Vocabulary_Kanji

  // Audit fields
  createdById Int?
  createdBy   User? @relation("VocabularyCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  flashcardCards  FlashcardCard[]
  searchHistories VocabularySearchHistory[]

  @@index([wordJp])
  @@index([reading])
  @@index([levelN])
  @@index([wordTypeId])
}

model VocabularySearchHistory {
  id            Int         @id @default(autoincrement())
  userId        Int
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  vocabularyId  Int?
  vocabulary    Vocabulary? @relation(fields: [vocabularyId], references: [id], onDelete: SetNull)
  searchKeyword String      @db.VarChar(500) // Từ khóa tìm kiếm
  createdAt     DateTime    @default(now())

  @@index([userId])
  @@index([vocabularyId])
  @@index([createdAt])
  @@index([searchKeyword])
}

model Reward {
  id           Int          @id @default(autoincrement())
  nameKey      String       @unique
  rewardType   RewardType   @default(LESSON)
  rewardItem   Int
  rewardTarget RewardTarget @default(EXP)

  // Quan hệ với Translation
  nameTranslations Translation[]

  // Quan hệ với Level
  levels Level[]

  // Quan hệ với Lesson
  lessons           Lesson[]
  seasonRankRewards SeasonRankReward[]

  // Audit fields
  createdById Int?
  createdBy   User? @relation("RewardCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("RewardUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("RewardDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  // Timestamps
  deletedAt           DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  DailyRequest        DailyRequest[]
  Achievement         Achievement[]
  userRewardHistories UserRewardHistory[]
}

model UserRewardHistory {
  id                   Int                  @id @default(autoincrement())
  userId               Int
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rewardId             Int?
  reward               Reward?              @relation(fields: [rewardId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rewardTargetSnapshot RewardTarget?
  amount               Int?
  sourceType           UserRewardSourceType
  sourceId             Int?
  note                 String?              @db.VarChar(1000)
  meta                 Json?
  createdAt            DateTime             @default(now())

  @@index([userId])
  @@index([rewardId])
  @@index([sourceType])
}

model Level {
  id Int @id @default(autoincrement())

  levelNumber Int
  requiredExp Int
  levelType   LevelType @default(USER)

  // Self relation: next level
  nextLevelId Int?
  nextLevel   Level?  @relation("NextLevel", fields: [nextLevelId], references: [id])
  prevLevels  Level[] @relation("NextLevel")

  // Reward relation
  rewardId Int?
  reward   Reward? @relation(fields: [rewardId], references: [id])

  users User[]

  createdById Int?
  createdBy   User? @relation("LevelCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("LevelUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("LevelDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([levelNumber, levelType])
  @@index([deletedAt])
}

model Pokemon {
  id               Int           @id @default(autoincrement())
  pokedex_number   Int
  nameJp           String
  nameTranslations Json // {"en": "...", "ja": "...", "vi": "..."}
  description      String?
  conditionLevel   Int?
  isStarted        Boolean       @default(false)
  imageUrl         String?
  rarity           RarityPokemon @default(COMMON)

  // Quan hệ nhiều-nhiều với hệ
  types ElementalType[]

  // Self relation: tiến hóa
  nextPokemons     Pokemon[] @relation("PokemonEvolutions")
  previousPokemons Pokemon[] @relation("PokemonEvolutions")

  userPokemons UserPokemon[]

  //
  createdById Int?
  createdBy   User? @relation("PokemonCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("PokemonUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("PokemonDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt        DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  ShopItem         ShopItem[]
  GachaItem        GachaItem[]
  GachaRollHistory GachaRollHistory[]
}

model UserPokemon {
  id Int @id @default(autoincrement())

  // Quan hệ
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  pokemonId Int
  pokemon   Pokemon @relation(fields: [pokemonId], references: [id], onDelete: NoAction)

  // Thông tin cá nhân hóa
  nickname  String? // tên user đặt cho con này
  exp       Int     @default(0) // exp hiện tại trên con này
  isEvolved Boolean @default(false) // đã tiến hóa chưa
  isMain    Boolean @default(false) // có phải con chính không

  matchRoundParticipants MatchRoundParticipant[]

  // Timestamps
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([pokemonId])
}

model ElementalType {
  id           Int      @id @default(autoincrement())
  type_name    String   @unique @db.VarChar(20) // Fire, Water...
  display_name Json // {"en": "Fire", "vi": "Lửa", "ja": "ほのお"}
  color_hex    String   @db.VarChar(7) // #EE8130
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  // Quan hệ nhiều-nhiều với Pokémon
  pokemons Pokemon[]

  // Quan hệ tấn công / phòng thủ
  attacking_relations TypeEffectiveness[] @relation("Attacker")
  defending_relations TypeEffectiveness[] @relation("Defender")

  //
  createdById Int?
  createdBy   User? @relation("ElementalTypeCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("ElementalTypeUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("ElementalTypeDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model TypeEffectiveness {
  id         Int   @id @default(autoincrement())
  attackerId Int
  defenderId Int
  multiplier Float // 0, 0.5, 1, 2

  attacker ElementalType @relation("Attacker", fields: [attackerId], references: [id])
  defender ElementalType @relation("Defender", fields: [defenderId], references: [id])

  //
  createdById Int?
  createdBy   User? @relation("TypeEffectivenessCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("TypeEffectivenessUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("TypeEffectivenessDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([attackerId, defenderId]) // tránh trùng
}

// Model LessonCategory (Danh mục bài học)
model LessonCategory {
  id        Int      @id @default(autoincrement())
  nameKey   String   @unique @db.VarChar(200) // Key để dịch tên danh mục
  slug      String   @unique @db.VarChar(200) // URL slug cho danh mục
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quan hệ với Lesson
  lessons Lesson[]

  @@index([nameKey])
  @@index([slug])
}

// Model Lesson (Bài học)
model Lesson {
  id                   Int       @id @default(autoincrement())
  slug                 String    @unique @db.VarChar(200) // URL slug cho bài học
  titleJp              String    @db.VarChar(500) // Tiêu đề bài học bằng tiếng Nhật
  titleKey             String    @db.VarChar(500) // Key để dịch tiêu đề bài học
  levelJlpt            Int? // Cấp độ JLPT (1-5)
  estimatedTimeMinutes Int       @default(30) // Thời gian ước tính hoàn thành (phút)
  lessonOrder          Int       @default(0) // Thứ tự bài học trong danh mục
  isPublished          Boolean   @default(false) // Trạng thái xuất bản
  publishedAt          DateTime? // Thời gian xuất bản
  version              String    @default("1.0.0") @db.VarChar(20) // Phiên bản bài học
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Quan hệ với LessonCategory
  lessonCategoryId Int
  lessonCategory   LessonCategory @relation(fields: [lessonCategoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Quan hệ với Reward
  rewardId Int?
  reward   Reward? @relation(fields: [rewardId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  // Quan hệ với Test (Bài test ôn tập)
  testId Int?
  test   Test? @relation("LessonTest", fields: [testId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  // Quan hệ với User (created_by)
  createdById Int
  createdBy   User @relation("LessonCreatedBy", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Quan hệ với LessonContents
  lessonContents LessonContents[]

  // Quan hệ với Exercises
  exercises Exercises[]

  // Quan hệ với UserProgress
  userProgresses UserProgress[]

  @@index([slug])
  @@index([titleKey])
  @@index([levelJlpt])
  @@index([lessonCategoryId])
  @@index([lessonOrder])
  @@index([isPublished])
  @@index([publishedAt])
  @@index([testId])
}

// Model LessonContents (Nội dung bài học)
model LessonContents {
  id           Int      @id @default(autoincrement())
  lessonId     Int // Foreign key đến Lesson
  contentId    Int // Polymorphic foreign key
  contentType  String   @db.VarChar(50) // Loại nội dung (vocabulary, grammar, kanji, etc.)
  contentOrder Int      @default(0) // Thứ tự nội dung trong bài học
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Quan hệ với Lesson
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Polymorphic relationships (sẽ được xử lý trong service layer)
  // contentId có thể trỏ đến Vocabulary.ID, Grammar.ID, hoặc Kanji.ID
  // tùy thuộc vào giá trị của contentType

  @@index([lessonId])
  @@index([contentId])
  @@index([contentType])
  @@index([contentOrder])
}

// Model Exercises (Bài tập)
model Exercises {
  id           Int      @id @default(autoincrement())
  exerciseType String   @db.VarChar(100) // Loại bài tập (multiple_choice, fill_blank, etc.)
  isBlocked    Boolean  @default(false) // Trạng thái bị chặn
  createdAt    DateTime @default(now()) @db.Timestamp(3)
  updatedAt    DateTime @updatedAt @db.Timestamp(3)

  lessonId Int // Foreign key đến Lesson
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  testSetId Int?     @unique // Foreign key đến TestSet
  testSet   TestSet? @relation(fields: [testSetId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  userExerciseAttempts UserExerciseAttempt[]

  @@index([lessonId])
  @@index([testSetId])
  @@index([exerciseType])
  @@index([isBlocked])
}

// Model QuestionBank (Ngân hàng câu hỏi)
model QuestionBank {
  id           Int          @id @default(autoincrement())
  questionJp   String?      @db.VarChar(1000) // Nội dung câu hỏi bằng tiếng Nhật (cũng là expectedText)
  questionType QuestionType @default(VOCABULARY) // Loại câu hỏi (VOCABULARY, GRAMMAR, KANJI, LISTENING, etc.)
  audioUrl     String?      @db.VarChar(1000) // URL file âm thanh
  questionKey  String?      @db.VarChar(200) // Key để dịch câu hỏi

  role RoleSpeaking?

  pronunciation String? @db.VarChar(1000) // Phiên âm (romaji)
  levelN        Int?    @default(1) // Độ khó (1-5)
  // Audit fields
  createdById   Int?
  createdBy     User?   @relation("QuestionBankCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  createdAt DateTime @default(now()) @db.Timestamp(3)
  updatedAt DateTime @updatedAt @db.Timestamp(3)

  // Quan hệ với Answer
  answers        Answer[]
  // Quan hệ với UserAnswerLog
  userAnswerLogs UserAnswerLog[]

  // Quan hệ với UserTestAnswerLog
  userTestAnswerLogs UserTestAnswerLog[] @relation("QuestionBankUserTestAnswerLogs")

  // Quan hệ với TestSetQuestionBank (bảng nối)
  testSetQuestionBanks TestSetQuestionBank[]
  roundQuestions       RoundQuestion[]

  @@index([questionType])
  @@index([questionKey])
  @@index([createdById])
}

// Model TestSet (Bộ đề)
model TestSet {
  id          Int           @id @default(autoincrement())
  name        String        @db.VarChar(200) // Tên bộ đề
  description String?       @db.Text // Mô tả bộ đề
  content     String?       @db.Text // Nội dung mô tả bộ đề
  audioUrl    String?       @db.VarChar(1000) // URL file âm thanh
  price       Decimal?      @db.Decimal(10, 2) // Giá bộ đề (nếu có)
  levelN      Int? // Cấp độ JLPT (1-5)
  testType    TestSetType   @default(VOCABULARY) // Loại đề thi (vocabulary, grammar, kanji, listening, etc.)
  status      TestSetStatus @default(DRAFT) // Trạng thái (DRAFT, ACTIVE, INACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  exercises Exercises[] // Quan hệ ngược lại với Exercises

  // Quan hệ với TestSetQuestionBank (bảng nối)
  testSetQuestionBanks TestSetQuestionBank[]

  // Quan hệ nhiều-nhiều với Test (bảng nối)
  testTestSets TestTestSet[] @relation("TestSetTestTests")

  // Quan hệ với User
  creatorId Int?
  creator   User? @relation("TestSetCreatedBy", fields: [creatorId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([levelN])
  @@index([testType])
  @@index([status])
  @@index([creatorId])
}

// Thực thể bài kiểm tra tổng hợp
model Test {
  id          Int           @id @default(autoincrement())
  name        String        @db.VarChar(200) // Tên bài test
  description String?       @db.Text // Mô tả bài test
  price       Decimal?      @db.Decimal(10, 2) // Giá bài test (nếu có)
  levelN      Int?          @default(0) // Cấp độ JLPT (0-5) 0 tức nhiều cấp độ
  limit       Int?          @default(0) // Giới hạn số lần làm bài test
  testType    TestStatus    @default(PLACEMENT_TEST_DONE) // Loại đề thi
  status      TestSetStatus @default(DRAFT) // Trạng thái (DRAFT, ACTIVE, INACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Quan hệ nhiều-nhiều với TestSet (bảng nối)
  testTestSets TestTestSet[] @relation("TestTestSets")

  // Quan hệ với User
  creatorId Int?
  creator   User? @relation("TestCreatedBy", fields: [creatorId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  // Quan hệ với UserTest (sở hữu)
  userTests UserTest[] @relation("TestUserTests")

  // Quan hệ với UserTestAttempt
  userTestAttempts UserTestAttempt[] @relation("TestUserTestAttempts")

  // Quan hệ với Lesson (Bài test ôn tập cho lesson)
  lessons        Lesson[]       @relation("LessonTest")
  userProgresses UserProgress[]

  @@index([testType])
  @@index([status])
  @@index([creatorId])
}

// Model TestTestSet (Bảng nối giữa Test và TestSet - Nhiều-Nhiều)
model TestTestSet {
  id        Int      @id @default(autoincrement())
  testId    Int // Foreign key đến Test
  testSetId Int // Foreign key đến TestSet
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Quan hệ với Test
  test Test @relation("TestTestSets", fields: [testId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Quan hệ với TestSet
  testSet TestSet @relation("TestSetTestTests", fields: [testSetId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([testId, testSetId]) // Một Test chỉ có thể có một TestSet một lần
  @@index([testId])
  @@index([testSetId])
}

// Model TestSetQuestionBank (Bảng nối giữa TestSet và QuestionBank)
model TestSetQuestionBank {
  id             Int      @id @default(autoincrement())
  testSetId      Int // Foreign key đến TestSet
  questionBankId Int // Foreign key đến QuestionBank
  questionOrder  Int      @default(0) // Thứ tự câu hỏi trong bộ đề
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Quan hệ với TestSet
  testSet TestSet @relation(fields: [testSetId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Quan hệ với QuestionBank
  questionBank QuestionBank @relation(fields: [questionBankId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([testSetId, questionBankId]) // Tránh trùng lặp
  @@index([testSetId])
  @@index([questionBankId])
  @@index([questionOrder])
}

// Model Answer (Câu trả lời)
model Answer {
  id             Int      @id @default(autoincrement())
  answerJp       String?  @db.VarChar(1000) // Nội dung câu trả lời bằng tiếng Nhật
  answerKey      String?  @db.VarChar(200) // Key để dịch câu trả lời
  isCorrect      Boolean  @default(false) // Đánh dấu câu trả lời đúng
  createdAt      DateTime @default(now()) @db.Timestamp(3)
  updatedAt      DateTime @updatedAt @db.Timestamp(3)
  questionBankId Int // Foreign key đến QuestionBank

  // Quan hệ với QuestionBank
  questionBank QuestionBank @relation(fields: [questionBankId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Quan hệ với UserAnswerLog
  userAnswerLogs UserAnswerLog[]

  // Quan hệ với UserTestAnswerLog
  userTestAnswerLogs       UserTestAnswerLog[]       @relation("AnswerUserTestAnswerLogs")
  roundQuestionsAnswerLogs RoundQuestionsAnswerLog[]

  @@index([questionBankId])
  @@index([answerKey])
  @@index([isCorrect])
}

// Enum cho trạng thái làm bài tập
enum ExerciseAttemptStatus {
  NOT_STARTED // Chưa bắt đầu
  IN_PROGRESS // Đang làm
  COMPLETED // Đã hoàn thành
  FAILED // Đã hoàn thành nhưng sai
  ABANDONED // Đã bỏ dở
  SKIPPED // Đã bỏ qua
}

enum TestAttemptStatus {
  NOT_STARTED // Chưa bắt đầu
  IN_PROGRESS // Đang làm
  COMPLETED // Đã hoàn thành
  FAILED // Đã hoàn thành nhưng sai
  ABANDONED // Đã bỏ dở
  SKIPPED // Đã bỏ qua
}

enum FlashcardDeckStatus {
  ACTIVE
  ARCHIVED
}

enum FlashcardDeckSource {
  SYSTEM
  USER
}

enum FlashcardCardStatus {
  ACTIVE
  ARCHIVED
}

enum FlashcardContentType {
  VOCABULARY
  KANJI
  GRAMMAR
  CUSTOM
}

model FlashcardDeck {
  id        Int                 @id @default(autoincrement())
  userId    Int
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String              @db.VarChar(200)
  status    FlashcardDeckStatus @default(ACTIVE)
  source    FlashcardDeckSource @default(USER)
  metadata  Json?
  deletedAt DateTime?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  cards FlashcardCard[]

  @@index([userId])
  @@index([status])
}

model FlashcardCard {
  id           Int                  @id @default(autoincrement())
  deckId       Int
  deck         FlashcardDeck        @relation(fields: [deckId], references: [id], onDelete: Cascade)
  contentType  FlashcardContentType
  vocabularyId Int?
  vocabulary   Vocabulary?          @relation(fields: [vocabularyId], references: [id], onDelete: SetNull)
  kanjiId      Int?
  kanji        Kanji?               @relation(fields: [kanjiId], references: [id], onDelete: SetNull)
  grammarId    Int?
  grammar      Grammar?             @relation(fields: [grammarId], references: [id], onDelete: SetNull)
  customFront  String?              @db.Text
  customBack   String?              @db.Text
  notes        String?              @db.Text
  imageUrl     String?              @db.VarChar(1000)
  audioUrl     String?              @db.VarChar(1000)
  status       FlashcardCardStatus  @default(ACTIVE)
  metadata     Json?
  deletedAt    DateTime?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@index([deckId])
  @@index([contentType])
}

// Model UserExerciseAttempt (Lần thử bài tập của user)
model UserExerciseAttempt {
  id         Int                   @id @default(autoincrement())
  userId     Int
  user       User                  @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  exerciseId Int
  exercise   Exercises             @relation(fields: [exerciseId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  time       Int?                  @default(0) // Thời gian làm bài (giây)
  status     ExerciseAttemptStatus @default(IN_PROGRESS)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt

  // Quan hệ với UserAnswerLog
  userAnswerLogs UserAnswerLog[]

  @@index([userId])
  @@index([exerciseId])
  @@index([status])
}

// Model UserAnswerLog (Log câu trả lời của user)
model UserAnswerLog {
  id                    Int                 @id @default(autoincrement())
  isCorrect             Boolean             @default(false)
  userExerciseAttemptId Int
  userExerciseAttempt   UserExerciseAttempt @relation(fields: [userExerciseAttemptId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  questionBankId        Int
  questionBank          QuestionBank        @relation(fields: [questionBankId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  answerId              Int
  answer                Answer              @relation(fields: [answerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([userExerciseAttemptId])
  @@index([questionBankId])
  @@index([answerId])
}

// Model UserTest (Sở hữu Test của user)
model UserTest {
  id        Int            @id @default(autoincrement())
  userId    Int
  user      User           @relation("UserTests", fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  testId    Int
  test      Test           @relation("TestUserTests", fields: [testId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  status    UserTestStatus @default(NOT_STARTED)
  limit     Int?           @default(0) // Giới hạn số lần làm bài test
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@unique([userId, testId]) // Một user chỉ sở hữu một test một lần
  @@index([userId])
  @@index([testId])
}

// Model UserTestAttempt (Lần thử Test của user)
model UserTestAttempt {
  id        Int               @id @default(autoincrement())
  userId    Int
  user      User              @relation("UserTestAttempts", fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  testId    Int
  test      Test              @relation("TestUserTestAttempts", fields: [testId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  time      Int?              @default(0) // Thời gian làm bài (giây)
  status    TestAttemptStatus @default(IN_PROGRESS)
  score     Int?              @default(0) // Điểm số
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // Quan hệ với UserTestAnswerLog
  userTestAnswerLogs UserTestAnswerLog[] @relation("UserTestAttemptAnswerLogs")

  @@index([userId])
  @@index([testId])
  @@index([status])
}

// Model UserTestAnswerLog (Log câu trả lời của user trong Test)
model UserTestAnswerLog {
  id                Int             @id @default(autoincrement())
  isCorrect         Boolean         @default(false)
  userTestAttemptId Int
  userTestAttempt   UserTestAttempt @relation("UserTestAttemptAnswerLogs", fields: [userTestAttemptId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  questionBankId    Int
  questionBank      QuestionBank    @relation("QuestionBankUserTestAnswerLogs", fields: [questionBankId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  answerId          Int
  answer            Answer          @relation("AnswerUserTestAnswerLogs", fields: [answerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  turnNumber        Int? // Số thứ tự turn (nếu là matching)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([userTestAttemptId])
  @@index([questionBankId])
  @@index([answerId])
  @@index([turnNumber])
}

model Grammar {
  id        Int      @id @default(autoincrement())
  structure String   @db.VarChar(500)
  level     String   @db.VarChar(10)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  usages         GrammarUsage[]
  flashcardCards FlashcardCard[]

  @@index([level])
  @@index([structure])
}

model GrammarUsage {
  id                 Int      @id @default(autoincrement())
  grammarId          Int
  explanationKey     String   @db.VarChar(200)
  exampleSentenceJp  String   @db.VarChar(1000)
  exampleSentenceKey String   @db.VarChar(200)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  grammar Grammar @relation(fields: [grammarId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([grammarId])
  @@index([explanationKey])
}

model DailyRequest {
  id             Int    @id @default(autoincrement())
  nameKey        String @unique @db.VarChar(200)
  descriptionKey String @unique @db.VarChar(500)

  dailyRequestType DailyRequestType @default(DAILY_LESSON)
  conditionValue   Int // Giá trị cần đạt (VD: 1, 7, ...)

  rewardId Int? // Liên kết tới Reward
  reward   Reward? @relation(fields: [rewardId], references: [id], onDelete: SetNull)

  isStreak Boolean @default(false)
  isActive Boolean @default(true)

  userDailyRequests UserDailyRequest[]

  //translation
  nameTranslations        Translation[] @relation("DailyRequestNameRelation")
  descriptionTranslations Translation[] @relation("DailyRequestDescriptionRelation")

  //
  createdById Int?
  createdBy   User? @relation("DailyRequestCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("DailyRequestUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("DailyRequestDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model UserDailyRequest {
  id             Int          @id @default(autoincrement())
  userId         Int
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyRequestId Int
  dailyRequest   DailyRequest @relation(fields: [dailyRequestId], references: [id], onDelete: Cascade)
  progress       Int          @default(0) // Tiến độ hiện tại
  isCompleted    Boolean      @default(false)
  completedAt    DateTime?
  date           DateTime // Ngày của nhiệm vụ (ví dụ: 2025-10-12)
  //
  createdById    Int?
  createdBy      User?        @relation("UserDailyRequestCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById    Int?
  updatedBy      User?        @relation("UserDailyRequestUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById    Int?
  deletedBy      User?        @relation("UserDailyRequestDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([userId, dailyRequestId, date])
}

// === BẢNG ĐỊNH NGHĨA TOÀN BỘ HUY HIỆU ===
model AchievementGroup {
  id               Int           @id @default(autoincrement())
  nameKey          String        @unique
  displayOrder     Int // Thứ tự hiển thị, VD: 1, 2, 3...
  isActive         Boolean       @default(true)
  // Quan hệ: Một nhóm có thể chứa nhiều huy hiệu
  achievements     Achievement[]
  //translation
  nameTranslations Translation[] @relation("AchievementGroupNameRelation")

  createdById Int?
  createdBy   User? @relation("AchievementGroupCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("AchievementGroupUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("AchievementGroupDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Achievement {
  id Int @id @default(autoincrement())

  // Thông tin cơ bản
  nameKey             String               @unique
  descriptionKey      String               @unique
  conditionTextKey    String               @unique
  imageUrl            String?
  isActive            Boolean              @default(true)
  // Phân loại & Hiển thị
  achievementTierType AchievementTierType?
  // Điều kiện để nhận
  conditionType       AchievementType // Loại điều kiện, VD: LEARNING_STREAK
  conditionValue      Int? // Giá trị cần đạt, VD: 3 (cho 3 ngày)
  conditionElementId  Int? // Yếu tố liên quan (nếu có)  // Phần thưởng (nếu có) // hoac bai nao do
  rewardId            Int? // Liên kết tới bảng Reward
  reward              Reward?              @relation(fields: [rewardId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  groupId Int
  group   AchievementGroup @relation(fields: [groupId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Quan hệ: Một huy hiệu có thể được nhiều user sở hữu
  userAchievements UserAchievement[]

  //translation
  nameTranslations          Translation[] @relation("AchievementNameRelation")
  descriptionTranslations   Translation[] @relation("AchievementDescriptionRelation")
  conditionTextTranslations Translation[] @relation("AchievementConditionTextRelation")

  createdById Int?
  createdBy   User? @relation("AchievementCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("AchievementUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("AchievementDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model UserAchievement {
  id Int @id @default(autoincrement())

  // Liên kết tới User nào?
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Liên kết tới Huy hiệu nào?
  achievementId Int
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Thông tin thêm
  achievedAt DateTime?
  status     UserAchievementStatus @default(IN_PROGRESS) // Trạng thái của huy hiệu

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Đảm bảo một user chỉ nhận 1 huy hiệu 1 lần duy nhất
  @@unique([userId, achievementId])
}

// Model UserProgress (Tiến độ học tập của user)
model UserProgress {
  id                 Int            @id @default(autoincrement())
  userId             Int
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lessonId           Int
  lesson             Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  status             ProgressStatus @default(NOT_STARTED)
  progressPercentage Int            @default(0) // Phần trăm hoàn thành (0-100)
  completedAt        DateTime? // Thời điểm hoàn thành
  lastAccessedAt     DateTime       @default(now()) // Thời điểm truy cập cuối

  //Test
  testId Int?
  test   Test? @relation(fields: [testId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lessonId]) // Một user chỉ có 1 tiến độ cho 1 lesson
  @@index([userId])
  @@index([lessonId])
  @@index([status])
  @@index([progressPercentage])
  @@index([completedAt])
  @@index([testId])
}

model AttendanceConfig {
  id        Int     @id @default(autoincrement())
  dayOfWeek WeekDay @unique
  bonusCoin Int     @default(0)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  baseCoin  Int       @default(0)

  createdById Int?
  createdBy   User? @relation("AttendanceConfigCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("AttendanceConfigDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("AttendanceConfigUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)
}

model Attendance {
  id        Int              @id @default(autoincrement())
  date      DateTime
  status    AttendanceStatus
  coin      Int              @default(0)
  bonusCoin Int              @default(0)

  userId Int
  user   User @relation(fields: [userId], references: [id])

  createdById Int?
  createdBy   User? @relation("AttendanceCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("AttendanceDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("AttendanceUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([userId, date])
}

model Wallet {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  type    WalletType @default(SPARKLES) // SPARKLES | POKÉ_COINS
  balance Int        @default(0)

  transactions WalletTransaction[]

  createdById Int?
  createdBy   User? @relation("WalletCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("WalletDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("WalletUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([userId, type]) // Một user chỉ có 1 ví cho mỗi loại tiền
  @@index([userId])
  @@index([type])
}

model WalletTransaction {
  id Int @id @default(autoincrement())

  walletId Int
  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  purpose     TransactionPurpose // SUBSCRIPTION | GACHA | SHOP | QUIZ_ATTEMPT | REWARD | REFUND
  referenceId Int? // liên kết đến entity cụ thể (vd: subscriptionId, shopOrderId,...)
  // quan hệ cụ thể cho subscription (nếu là purpose = SUBSCRIPTION)
  //todo sau này có mấy bảng liên quan thì thêm vào đây: ví dụ
  // subscription    Subscription?     @relation(fields: [referenceId], references: [id])

  amount      Int
  type        WalletTransactionType // INCREASE | DECREASE
  source      WalletSourceType // DAILY_CHECKIN | SUBSCRIPTION_DISCOUNT | etc.
  description String?               @db.VarChar(500)

  createdById Int?
  createdBy   User? @relation("WalletTransactionCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("WalletTransactionDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("WalletTransactionUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  deletedAt     DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  ShopPurchase  ShopPurchase[]
  GachaPurchase GachaPurchase[]
  invoices      Invoice[]

  @@index([walletId])
  @@index([userId])
}

model ShopBanner {
  id                     Int          @id @default(autoincrement())
  nameKey                String       @unique @db.VarChar(200)
  startDate              DateTime?
  endDate                DateTime?
  status                 BannerStatus @default(PREVIEW)
  min                    Int          @default(4)
  max                    Int          @default(8)
  enablePrecreate        Boolean      @default(false) // bật/tắt tự tạo
  precreateBeforeEndDays Int          @default(2) // tạo trước X ngày (mặc định 2)
  isRandomItemAgain      Boolean      @default(false) // có thể trùng item khi random lại

  // Quan hệ với ShopItem
  shopItems ShopItem[]

  //translate
  nameTranslations Translation[] @relation("ShopBannerNameRelation")

  createdById Int?
  createdBy   User? @relation("ShopBannerCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("ShopBannerDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("ShopBannerUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model ShopRarityPrice {
  id     Int           @id @default(autoincrement())
  rarity RarityPokemon
  price  Int           @default(1000)

  createdById Int?
  createdBy   User? @relation("ShopRarityPriceCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("ShopRarityPriceDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("ShopRarityPriceUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model ShopItem {
  id             Int        @id @default(autoincrement())
  shopBannerId   Int
  shopBanner     ShopBanner @relation(fields: [shopBannerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  pokemonId      Int
  pokemon        Pokemon    @relation(fields: [pokemonId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  price          Int
  purchaseLimit  Int? // Giới hạn mua (null = không giới hạn)
  purchasedCount Int        @default(0) // Số lượng đã bán
  isActive       Boolean    @default(true)

  //
  shopPurchases ShopPurchase[]

  createdById Int?
  createdBy   User? @relation("ShopItemCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("ShopItemDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("ShopItemUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([shopBannerId])
  @@index([pokemonId])
}

model ShopPurchase {
  id Int @id @default(autoincrement())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  shopItemId Int
  shopItem   ShopItem @relation(fields: [shopItemId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  walletTransId Int? // Gắn với WalletTransaction (nếu có)
  walletTrans   WalletTransaction? @relation(fields: [walletTransId], references: [id], onDelete: SetNull)

  quantity   Int @default(1)
  totalPrice Int

  // meta
  createdById Int?
  createdBy   User? @relation("ShopPurchaseCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("ShopPurchaseDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("ShopPurchaseUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([shopItemId])
  @@index([walletTransId])
}

// Banner chính
model GachaBanner {
  id        Int          @id @default(autoincrement())
  nameKey   String       @unique
  startDate DateTime?
  endDate   DateTime?
  status    BannerStatus @default(PREVIEW)

  hardPity5Star Int @default(200) // Số roll để chắc chắn ra 5★

  costRoll Int @default(100) // Chi phí cho mỗi lần roll

  // auto pre-create before end
  enablePrecreate        Boolean @default(false) // bật/tắt tự tạo
  precreateBeforeEndDays Int     @default(2) // tạo trước X ngày (mặc định 2)
  isRandomItemAgain      Boolean @default(false) // có thể trùng item khi random lại

  amount5Star Int @default(1) // Số lượng 5★
  amount4Star Int @default(3) // Số lượng 4★
  amount3Star Int @default(6) // Số lượng 3★
  amount2Star Int @default(8) // Số lượng 2★
  amount1Star Int @default(10) // Số lượng 1★

  // Quan hệ
  items     GachaItem[]
  purchases GachaPurchase[]
  rollLogs  GachaRollHistory[]

  //translate
  nameTranslations Translation[] @relation("GachaBannerNameRelation")

  // meta
  createdById Int?
  createdBy   User? @relation("GachaBannerCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("GachaBannerDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("GachaBannerUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// Tỉ lệ ra từng mức sao
model GachaItemRate {
  id Int @id @default(autoincrement())

  starType GachaStarType
  rate     Float // 0.3, 5.7, 14, 30, 50 (tổng các rate = 100%)

  gachaBannerItems GachaItem[]

  // meta
  createdById Int?
  createdBy   User? @relation("GachaItemRateCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("GachaItemRateDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("GachaItemRateUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// Danh sách Pokémon trong banner (gắn rate)
model GachaItem {
  id Int @id @default(autoincrement())

  bannerId Int
  banner   GachaBanner @relation(fields: [bannerId], references: [id], onDelete: Cascade)

  pokemonId Int
  pokemon   Pokemon @relation(fields: [pokemonId], references: [id], onDelete: Cascade)

  gachaItemRateId Int
  gachaItemRate   GachaItemRate @relation(fields: [gachaItemRateId], references: [id], onDelete: Cascade)

  // meta
  createdById Int?
  createdBy   User? @relation("GachaItemCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("GachaItemDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("GachaItemUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([bannerId, pokemonId]) // Một Pokémon chỉ xuất hiện 1 lần trong 1 banner
}

// Lưu mỗi lần user roll (1 roll hoặc 10 roll)
model GachaPurchase {
  id Int @id @default(autoincrement())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  bannerId Int
  banner   GachaBanner @relation(fields: [bannerId], references: [id], onDelete: Cascade)

  walletTransId Int?
  walletTrans   WalletTransaction? @relation(fields: [walletTransId], references: [id], onDelete: SetNull)

  rollCount Int @default(1) // 1 hoặc 10
  totalCost Int @default(0)

  // Danh sách kết quả roll của lần này
  rollResults GachaRollHistory[]

  // meta
  createdById Int?
  createdBy   User? @relation("GachaPurchaseCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("GachaPurchaseDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("GachaPurchaseUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  deletedAt       DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  UserGachaPity   UserGachaPity? @relation(fields: [userGachaPityId], references: [id])
  userGachaPityId Int?

  @@index([userId])
  @@index([bannerId])
  @@index([walletTransId])
}

// Lịch sử roll chi tiết từng Pokémon
model GachaRollHistory {
  id Int @id @default(autoincrement())

  purchaseId Int
  purchase   GachaPurchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  bannerId Int
  banner   GachaBanner @relation(fields: [bannerId], references: [id], onDelete: Cascade)

  pokemonId Int
  pokemon   Pokemon @relation(fields: [pokemonId], references: [id], onDelete: Cascade)

  rarity GachaStarType

  // Liên kết tới pity chung
  pityId     Int?
  pity       UserGachaPity? @relation(fields: [pityId], references: [id], onDelete: SetNull)
  pityNow    Int
  pityStatus GachaPityType  @default(PENDING)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([purchaseId])
  @@index([userId])
  @@index([bannerId])
}

model UserGachaPity {
  id        Int           @id @default(autoincrement())
  userId    Int
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  pityCount Int
  status    GachaPityType @default(PENDING)

  gachaRollHistories GachaRollHistory[]
  gachaPurchases     GachaPurchase[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
}

// Hàng đợi khi user bấm tìm trận (kèm 3 Pokemon)
model MatchQueue {
  id Int @id @default(autoincrement())

  userId Int  @unique // 1 user chỉ ở trong hàng đợi 1 lần
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  userElo Int // Snapshot Elo của user lúc vào hàng đợi
  status  QueueStatus @default(WAITING)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([status, userElo])
  @@index([userId])
}

/// Đại diện cho toàn bộ 1 trận đấu
model Match {
  id     Int         @id @default(autoincrement())
  status MatchStatus @default(PENDING)

  leaderboardSeasonId Int
  leaderboardSeason   LeaderboardSeason @relation(fields: [leaderboardSeasonId], references: [id])

  // --- KẾT QUẢ CHUNG CUỘC ---
  // Được cập nhật khi 3 MatchRound đều COMPLETED
  winnerId  Int?
  winner    User? @relation("WonMatches", fields: [winnerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  eloGained Int?
  eloLost   Int?
  // ---

  // Quan hệ 1-n: 1 trận có 2 người tham gia
  participants MatchParticipant[]

  // Quan hệ 1-n: 1 trận có 3 round
  rounds MatchRound[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([status])
  @@index([winnerId])
}

// Đại diện cho 1 user tham gia 1 trận đấu (Lưu trạng thái Accept)
model MatchParticipant {
  id Int @id @default(autoincrement())

  matchId Int
  match   Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Trạng thái chấp nhận ban đầu
  hasAccepted Boolean?

  // Quan hệ 1-n: 1 người tham gia có 3 "kết quả round"
  roundResults MatchRoundParticipant[]

  // Quan hệ ngược (để biết ai thắng round nào)
  wonRounds MatchRound[] @relation("RoundWinner")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([matchId, userId])
}

/// Đại diện cho 1 Round (Vòng 1, 2, 3) của 1 Trận đấu
model MatchRound {
  id Int @id @default(autoincrement())

  matchId Int
  match   Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  // "sẽ có roundOrder làm điều đó"
  roundNumber MatchRoundNumber @default(ONE) // 1, 2, hoặc 3

  status        RoundStatus       @default(SELECTING_POKEMON)
  endTimeRound  DateTime? // Thời gian kết thúc round (khi status thành improgress )
  // --- KẾT QUẢ ROUND ---
  // Được cập nhật sau khi so sánh 2 record "con"
  roundWinnerId Int?
  roundWinner   MatchParticipant? @relation("RoundWinner", fields: [roundWinnerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  // ---

  // Quan hệ 1-n: 1 round có 2 "người tham gia round" (User A và B)
  participants MatchRoundParticipant[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([matchId, roundNumber]) // Đảm bảo R1, R2, R3 là duy nhất cho 1 trận
}

/// Bảng chi tiết: Lưu Pokémon đã chọn VÀ Kết quả (điểm, thời gian) của 1 user cho 1 round
model MatchRoundParticipant {
  id Int @id @default(autoincrement())

  // Liên kết với người tham gia (Ai?)
  matchParticipantId Int
  matchParticipant   MatchParticipant @relation(fields: [matchParticipantId], references: [id], onDelete: Cascade)

  // Liên kết với round (Round nào?)
  matchRoundId Int
  matchRound   MatchRound @relation(fields: [matchRoundId], references: [id], onDelete: Cascade)

  // --- POKÉMON ĐÃ CHỌN CHO ROUND NÀY ---
  orderSelected         Int          @default(1) // Thứ tự chọn Pokémon (1, 2, 3)
  endTimeSelected       DateTime? // Thời gian kết thúc chọn Pokémon
  selectedUserPokemonId Int? // Ban đầu null, được update khi chọn
  selectedUserPokemon   UserPokemon? @relation(fields: [selectedUserPokemonId], references: [id], onDelete: NoAction)

  //debuff áp dụng cho participant này trong round này
  debuffId Int?
  debuff   DebuffRound? @relation(fields: [debuffId], references: [id], onDelete: SetNull)

  // --- KẾT QUẢ CHI TIẾT ---
  points         Int?
  totalTimeMs    Int?
  questionsTotal Int               @default(10) // 11 nếu bị debuff
  status         RoundResultStatus @default(SELECTING_POKEMON) // PENDING, COMPLETED

  roundQuestions RoundQuestion[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // 1 user chỉ có 1 record cho 1 round
  @@unique([matchParticipantId, matchRoundId])
  @@index([selectedUserPokemonId])
}

model RoundQuestion {
  id Int @id @default(autoincrement())

  matchRoundParticipantId Int
  matchRoundParticipant   MatchRoundParticipant @relation(fields: [matchRoundParticipantId], references: [id], onDelete: Cascade)

  questionBankId Int
  questionBank   QuestionBank @relation(fields: [questionBankId], references: [id], onDelete: Cascade)

  debuffId Int?
  debuff   DebuffRound? @relation(fields: [debuffId], references: [id], onDelete: SetNull)

  timeLimitMs     Int       @default(60000) // Thời gian làm câu hỏi này (ms)
  endTimeQuestion DateTime? // Thời gian kết thúc câu hỏi này
  basePoints      Int       @default(100) // Điểm của câu hỏi này
  orderNumber     Int // Thứ tự câu hỏi trong danh sách (1-10 hoặc 1-11)

  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  deletedAt                DateTime?
  roundQuestionsAnswerLogs RoundQuestionsAnswerLog[]

  @@index([matchRoundParticipantId])
  @@index([questionBankId])
}

model RoundQuestionsAnswerLog {
  id Int @id @default(autoincrement())

  roundQuestionId Int
  roundQuestion   RoundQuestion @relation(fields: [roundQuestionId], references: [id], onDelete: Cascade)

  answerId Int?
  answer   Answer? @relation(fields: [answerId], references: [id], onDelete: Cascade)

  isCorrect    Boolean
  timeAnswerMs Int // Thời gian làm câu hỏi (ms)
  pointsEarned Int // Điểm nhận được cho câu hỏi này

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([roundQuestionId])
  @@index([answerId])
}

model DebuffRound {
  id          Int             @id @default(autoincrement())
  nameKey     String          @unique
  typeDebuff  MatchDebuffType @default(ADD_QUESTION)
  valueDebuff Int // Số câu hỏi mất đi hoặc số ms bị phạt thêm

  matchRoundParticipants MatchRoundParticipant[]

  //translate
  nameTranslations Translation[] @relation("DebuffRoundNameRelation")

  roundQuestions RoundQuestion[]

  // meta
  createdById Int?
  createdBy   User? @relation("DebuffMatchRoundParticipantCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("DebuffMatchRoundParticipantDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("DebuffMatchRoundParticipantUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model LeaderboardSeason {
  id        Int      @id @default(autoincrement())
  nameKey   String   @unique
  startDate DateTime
  endDate   DateTime
  hasOpened Boolean  @default(false)

  matches Match[] // Các trận đấu trong mùa này
  status  LeaderboardStatus @default(PREVIEW)

  enablePrecreate        Boolean @default(false) // bật/tắt tự tạo
  precreateBeforeEndDays Int     @default(2) // tạo trước X ngày (mặc định 2)
  isRandomItemAgain      Boolean @default(false) // có thể trùng item khi random lại

  // --- THÊM MỚI ---
  // Lịch sử user của mùa này
  userHistories     UserSeasonHistory[]
  seasonRankRewards SeasonRankReward[]

  //translate
  nameTranslations Translation[] @relation("LeaderboardSeasonNameRelation")

  // meta
  createdById Int?
  createdBy   User? @relation("LeaderboardSeasonCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("LeaderboardSeasonDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("LeaderboardSeasonUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([startDate])
  @@index([endDate])
  @@index([status])
}

model UserSeasonHistory {
  id Int @id @default(autoincrement())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  seasonId Int
  season   LeaderboardSeason @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  finalElo           Int? // Elo cuối cùng của user ở mùa giải này
  finalRank          String? // Tên rank cuối cùng (vd: "N4")
  seasonRankRewardId Int?
  seasonRankReward   SeasonRankReward? @relation(fields: [seasonRankRewardId], references: [id], onDelete: SetNull)
  rewardsClaimed     RewardClaimStatus @default(PENDING) // Đã nhận thưởng chưa

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([userId, seasonId]) // 1 user chỉ có 1 record lịch sử cho 1 mùa
  @@index([userId])
}

model SeasonRankReward {
  id       Int               @id @default(autoincrement())
  seasonId Int
  season   LeaderboardSeason @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  rankName RankName @default(N5) // Tên rank áp dụng (vd: "N4", "N3", "N5")
  order    Int? // Thứ hạng áp dụng (vd: 1, 2, 3)

  // ---rewards
  rewards             Reward[]
  userSeasonHistories UserSeasonHistory[]

  // meta
  createdById Int?
  createdBy   User? @relation("SeasonRankRewardCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("SeasonRankRewardDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("SeasonRankRewardUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([seasonId, rankName, order])
  @@index([seasonId])
  @@index([rankName])
}

model Subscription {
  id             Int                 @id @default(autoincrement())
  tagName        TagNameSubscription @default(NORMAL)
  nameKey        String              @unique
  descriptionKey String              @unique

  // Liên kết
  features                SubscriptionFeature[] // Các tính năng của sản phẩm này
  plans                   SubscriptionPlan[] // Các phương án giá của sản phẩm này
  // translation
  nameTranslations        Translation[]         @relation("SubscriptionNameRelation")
  descriptionTranslations Translation[]         @relation("SubscriptionDescriptionRelation")

  // --- Meta Fields ---
  createdById Int?
  createdBy   User? @relation("SubscriptionCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("SubscriptionDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("SubscriptionUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([tagName])
}

// Bảng định nghĩa các tính năng gốc (Từ điển)
model Feature {
  id         Int        @id @default(autoincrement())
  nameKey    String     @unique
  featureKey FeatureKey // Tính năng là gì (vd: XP_MULTIPLIER)

  // Translation (giống như model Subscription của bạn)
  nameTranslations Translation[] @relation("FeatureNameRelation")

  createdById Int?
  createdBy   User? @relation("FeatureCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("FeatureDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("FeatureUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  deletedAt            DateTime?
  subscriptionFeatures SubscriptionFeature[]
}

// Bảng trung gian định nghĩa chi tiết tính năng (ví dụ: "Gói Ultra" có "XP_MULTIPLIER" giá trị "1.2")
model SubscriptionFeature {
  id Int @id @default(autoincrement())

  subscriptionId Int
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  featureId Int
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Restrict) // Không cho xóa Feature nếu còn gói sử dụng

  value String? // Giá trị của tính năng (vd: "1.2", "true")

  // --- Meta Fields ---
  createdById Int?
  createdBy   User? @relation("SubscriptionFeatureCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("SubscriptionFeatureDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("SubscriptionFeatureUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([subscriptionId])
}

// Định nghĩa GIÁ & THỜI HẠN cho một Sản phẩm (ví dụ: "Gói Ultra" bán "Gói 1 Tháng" giá 129k)
model SubscriptionPlan {
  id             Int          @id @default(autoincrement())
  subscriptionId Int
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  isActive       Boolean      @default(false)

  // Thông tin giá
  price Int // Lưu 129000, 99000

  // Thông tin thời hạn
  type           SubscriptionType // LIFETIME hay RECURRING
  durationInDays Int? // 30, 90, 180. NULL nếu type = LIFETIME

  // Liên kết
  userSubscribers UserSubscription[]

  // --- Meta Fields ---
  createdById Int?
  createdBy   User? @relation("SubscriptionPlanCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("SubscriptionPlanDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("SubscriptionPlanUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  invoices  Invoice[]

  @@index([subscriptionId])
}

// Bảng ghi lại việc User đã mua "Phương án" nào
model UserSubscription {
  id Int @id @default(autoincrement())

  // --- Ai là người đăng ký ---
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- Mua "Phương án" nào ---
  subscriptionPlanId Int
  subscriptionPlan   SubscriptionPlan @relation(fields: [subscriptionPlanId], references: [id], onDelete: Restrict) // Không cho xóa Plan nếu user đã mua

  invoiceId Int       @unique // 1-1, bắt buộc
  invoice   Invoice   @relation(fields: [invoiceId], references: [id])
  // --- Thời hạn ---
  startDate DateTime?
  expiresAt DateTime? // NULL nếu là gói LIFETIME

  // --- Trạng thái ---
  status UserSubscriptionStatus @default(PENDING_PAYMENT)

  // --- Meta Fields ---
  // createdById ở đây có thể là Admin (nếu admin thêm thủ công),
  // khác với userId là người sở hữu gói
  createdById Int?
  createdBy   User? @relation("UserSubscriptionCreatedBy", fields: [createdById], references: [id], onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("UserSubscriptionDeletedBy", fields: [deletedById], references: [id], onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("UserSubscriptionUpdatedBy", fields: [updatedById], references: [id], onUpdate: NoAction)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId])
  @@index([subscriptionPlanId])
  @@index([expiresAt])
}

model Invoice {
  id Int @id @default(autoincrement())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  subscriptionPlanId Int
  subscriptionPlan   SubscriptionPlan @relation(fields: [subscriptionPlanId], references: [id])

  walletTransactionId Int?
  walletTransaction   WalletTransaction? @relation(fields: [walletTransactionId], references: [id], onDelete: SetNull)

  userSubscription UserSubscription?

  // --- CHI TIẾT TÀI CHÍNH ---
  subtotalAmount Int // Giá gốc của gói (ví dụ: 99000)
  discountAmount Int @default(0) // Số tiền giảm giá (ví dụ: 10000 từ coin)
  totalAmount    Int // Số tiền cuối cùng cần trả (ví dụ: 89000)

  status InvoiceStatus @default(PENDING)

  // --- LIÊN KẾT NGƯỢC ---
  // Một hóa đơn có thể có NHIỀU lần thử thanh toán (Payment)
  payments Payment[]

  // Một hóa đơn sẽ kích hoạt MỘT UserSubscription (khi thành công)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model Payment {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  invoiceId     Int
  invoice       Invoice       @relation(fields: [invoiceId], references: [id])
  paymentMethod PaymentMethod @default(BANK_TRANSFER)
  amount        Float         @default(0.0) // Số tiền thanh toán
  status        PaymentStatus @default(PENDING)

  // PayOS specific fields
  payosOrderId       String? @unique @db.VarChar(500) // PayOS order ID
  payosPaymentLinkId String? @db.VarChar(500) // PayOS payment link ID
  payosTransactionId String? @db.VarChar(500) // PayOS transaction ID
  payosQrCode        String? @db.Text // PayOS QR code
  payosCheckoutUrl   String? @db.VarChar(1000) // PayOS checkout URL

  // Cash payment fields
  receivedAmount Float? // Số tiền nhận được (cash)
  changeAmount   Float? // Số tiền thối lại (cash)

  // Payment gateway response
  gatewayResponse Json? // Raw response từ PayOS
  failureReason   String? @db.VarChar(1000) // Lý do thất bại

  // Timestamps
  paidAt    DateTime? // Thời gian thanh toán thành công
  expiredAt DateTime? // Thời gian hết hạn (PayOS)

  // Audit fields
  processedById Int?
  processedBy   User? @relation("PaymentProcessedBy", fields: [processedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([paymentMethod])
  @@index([payosOrderId])
  @@index([deletedAt])
}

enum PaymentMethod {
  BANK_TRANSFER // Chuyển khoản ngân hàng (PayOS)
}

enum PaymentStatus {
  PENDING // Đang chờ thanh toán
  PROCESSING // Đang xử lý
  PAID // Đã thanh toán thành công
  FAILED // Thanh toán thất bại
  CANCELLED // Đã hủy
  EXPIRED // Đã hết hạn
  REFUNDED // Đã hoàn tiền
}

enum InvoiceStatus {
  PENDING // Đang chờ (chưa thanh toán)
  PAID // Đã thanh toán
  CANCELLED // Đã hủy
}

enum UserSubscriptionStatus {
  PENDING_PAYMENT
  ACTIVE
  PAYMENT_FAILED
  CANCELED
}

enum TagNameSubscription {
  NORMAL
  COMBO
  ULTRA
}

// Loại gói: Mua 1 lần hay đăng ký lặp lại
enum SubscriptionType {
  LIFETIME
  RECURRING
}

// Các "khóa" tính năng để code của bạn có thể nhận diện
enum FeatureKey {
  UNLOCK_READING
  UNLOCK_LISTENING
  XP_MULTIPLIER
  COIN_MULTIPLIER
  UNLIMITED_TESTS
  PERSONALIZATION
  // Bạn có thể thêm các key khác ở đây
}

enum MatchDebuffType {
  ADD_QUESTION // Mất câu hỏi (tăng tổng số câu hỏi của đối thủ lên 1)
  DECREASE_POINT // Giảm điểm 1 câu (cộng thêm thời gian làm bài)
  DISCOMFORT_VISION // Giảm tầm nhìn (khó nhìn câu hỏi hơn)
}

enum MatchRoundNumber {
  ONE
  TWO
  THREE
}

/// Trạng thái của toàn bộ trận đấu (model Match)
enum MatchStatus {
  PENDING // Đang chờ Accept/Reject
  IN_PROGRESS // Đang chơi (bao gồm cả chọn Pokemon và làm bài)
  COMPLETED // Đã xong 3 round, đã tính ELO
  CANCELLED // Bị hủy
}

/// Trạng thái của 1 Round (model MatchRound)
enum RoundStatus {
  SELECTING_POKEMON // Đang trong giai đoạn chọn Pokemon cho round
  PENDING // chờ round khác chọn pokemon
  IN_PROGRESS // Đang trong giai đoạn làm bài (10 phút)
  COMPLETED // Đã so sánh xong kết quả
}

/// Trạng thái chi tiết của 1 user trong 1 round (model MatchRoundParticipant)
enum RoundResultStatus {
  SELECTING_POKEMON
  PENDING // Chờ đối thủ chọn Pokémon
  IN_PROGRESS // Đang làm bài (10 phút)
  COMPLETED // User đã nộp bài (points, time)
}

enum QueueStatus {
  WAITING // Đang chờ
}

enum ProgressStatus {
  NOT_STARTED // Chưa bắt đầu
  IN_PROGRESS // Đang học
  TESTING_LAST // Đang làm bài test
  COMPLETED // Đã hoàn thành
  FAILED // Đã thất bại
  TESTING_LAST_FAILED // Đã thất bại ở bài test cuối cùng
}

enum VerificationCodeType {
  REGISTER
  FORGOT_PASSWORD
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum HTTPMethod {
  GET
  POST
  PUT
  DELETE
  PATCH
  OPTIONS
  HEAD
}

enum MediaType {
  IMAGE
  VIDEO
}

enum LevelType {
  USER
}

enum RewardType {
  LESSON
  DAILY_REQUEST
  EVENT
  ACHIEVEMENT
  LEVEL
}

enum RewardTarget {
  EXP
  POKEMON
  POKE_COINS
  SPARKLES
}

enum RarityPokemon {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum DailyRequestType {
  DAILY_LOGIN
  DAILY_LESSON
  DAILY_EXERCISE
  STREAK_LOGIN
  STREAK_LESSON
  STREAK_EXCERCISE
}

enum DailyRequestCategoryType {
  DAILY
  WEEKLY
  MONTHLY
}

enum AchievementTierType {
  BASIC // Cơ bản
  INTERMEDIATE // Trung cấp
  ADVANCED // Nâng cao
  MASTER // Cao thủ
}

enum AchievementType {
  COMPLETE_LESSON // Hoàn thành bài học (value: 1 = bài đầu tiên)
  LEARNING_STREAK // Chuỗi ngày học (value: 3, 7, 30, 100)
}

enum TestSetStatus {
  DRAFT // Bản nháp
  ACTIVE // Đang hoạt động
  INACTIVE // Không hoạt động
}

enum WeekDay {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

enum QuestionType {
  VOCABULARY // Từ vựng
  GRAMMAR // Ngữ pháp
  KANJI // Kanji
  LISTENING // Nghe hiểu
  READING // Đọc hiểu
  SPEAKING // Nói
  GENERAL // Tổng hợp
  MATCHING // Ghép cặp
}

enum TestSetType {
  VOCABULARY // Từ vựng
  GRAMMAR // Ngữ pháp
  KANJI // Kanji
  LISTENING // Nghe hiểu
  READING // Đọc hiểu
  SPEAKING // Nói
  GENERAL // Tổng hợp
  MATCHING // Ghép cặp
  PLACEMENT_TEST_DONE // Kiểm tra đầu vào
}

enum WalletType {
  SPARKLES
  POKE_COINS
}

enum WalletTransactionType {
  INCREASE
  DECREASE
}

enum WalletSourceType {
  DAILY_CHECKIN
  EVENT_REWARD
  RANK_REWARD
  LESSON_PURCHASE
  SHOP_PURCHASE
  SUBSCRIPTION_DISCOUNT
  ADMIN_ADJUST
}

enum TransactionPurpose {
  SUBSCRIPTION
  GACHA
  SHOP
  DAILY_REQUEST
  REWARD
  REFUND
}

enum BannerStatus {
  ACTIVE // Đang áp dụng (hiển thị trên hệ thống)
  INACTIVE // Ngưng sử dụng (ẩn hoặc tắt hiển thị)
  EXPIRED // Hết hạn (đã qua thời gian kết thúc)
  PREVIEW // Xem trước (chưa chính thức áp dụng)
}

enum LeaderboardStatus {
  ACTIVE // Đang áp dụng (hiển thị trên hệ thống)
  INACTIVE // Ngưng sử dụng (ẩn hoặc tắt hiển thị)
  EXPIRED // Hết hạn (đã qua thời gian kết thúc)
  PREVIEW // Xem trước (chưa chính thức áp dụng)
}

// 🌟 Enum cho độ hiếm
enum GachaStarType {
  ONE
  TWO
  THREE
  FOUR
  FIVE
}

enum GachaPityType {
  PENDING // Đang trong chu kỳ (chưa reset)
  COMPLETED_MAX // Reset do đạt hard pity (ví dụ roll đủ 90 lần)
  COMPLETED_LUCK // Reset do roll hên ra 5★ trước khi đạt pity
}

enum LessonContentsType {
  VOCABULARY
  GRAMMAR
  KANJI
}

// === SRS review cho Vocabulary / Grammar / Kanji ===
enum SrsContentType {
  VOCABULARY
  GRAMMAR
  KANJI
  TEST
  EXERCISE
}

model UserSrsReview {
  id      Int     @id @default(autoincrement())
  userId  Int
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message String? @db.Text

  // Nội dung cần ôn: VOCABULARY | GRAMMAR | KANJI
  contentType SrsContentType
  contentId   Int

  // Lõi SRS
  srsLevel       Int      @default(0)
  nextReviewDate DateTime @default(now())

  // Phân tích điểm yếu
  incorrectStreak Int     @default(0)
  isLeech         Boolean @default(false)
  // Đánh dấu người dùng đã đọc/đã xem phân tích liên quan
  isRead          Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, contentType, contentId])
  @@index([userId, nextReviewDate])
}

// AI Policy scope for data access
enum AiPolicyScope {
  SELF_ONLY
  GROUP
  PUBLIC
}

enum TestStatus {
  PLACEMENT_TEST_DONE // Kiểm tra đầu vào
  SUBSCRIPTION_TEST // Kiểm tra đầu vào cho subscription
  MATCH_TEST // Trận đấu
  QUIZ_TEST //Quiz
  REVIEW_TEST // Ôn tập
  PRACTICE_TEST // Thi thử
  READING_TEST // Đọc hiểu
  LISTENING_TEST // Nghe hiểu
  SPEAKING_TEST // Nói
  LESSON_REVIEW // Ôn tập bài học
}

// === AI Recommendations ===
enum RecommendationTargetType {
  EXERCISE
  TEST
  LESSON
  VOCABULARY
  GRAMMAR
  KANJI
  QUESTION_BANK
}

enum RecommendationSourceType {
  PERSONALIZED
  SRS
}

enum RecommendationStatus {
  PENDING
  DONE
  DISMISSED
}

model UserAIRecommendation {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Đối tượng được khuyến nghị (exercise/test/lesson/vocabulary)
  targetType RecommendationTargetType
  targetId   Int

  reason    String                   @db.VarChar(1000)
  source    RecommendationSourceType @default(PERSONALIZED)
  modelUsed String?                  @db.VarChar(100)

  status    RecommendationStatus @default(PENDING)
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([userId, targetType, targetId])
}

enum UserTestStatus {
  NOT_STARTED // Chưa được assign/kích hoạt
  ACTIVE // Đã được assign và có thể sử dụng
}

enum GeminiConfigType {
  SPEAKING_EVALUATION // Đánh giá phát âm SPEAKING
  PERSONALIZED_RECOMMENDATIONS // Gợi ý cá nhân hóa
  AI_KAIWA // Hội thoại AI (AI Kaiwa)
  PERSONALIZED_RECOMMENDATIONS_ANALYZE
  AI_KAIWA_ROOM_TITLE // Tạo tiêu đề phòng hội thoại
  AI_KAIWA_TRANSLATION // Dịch câu hội thoại
}

model GeminiConfig {
  id                  Int               @id @default(autoincrement())
  geminiConfigModelId Int
  geminiConfigModel   GeminiConfigModel @relation(fields: [geminiConfigModelId], references: [id], onDelete: Restrict)
  prompt              String            @db.Text // Prompt template (có thể có placeholder như {{text}}, {{transcription}}, etc.)
  isActive            Boolean           @default(true) // Có đang sử dụng không

  createdById Int?
  createdBy   User? @relation("GeminiConfigCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("GeminiConfigUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("GeminiConfigDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt           DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  GeminiServiceConfig GeminiServiceConfig[]

  @@index([deletedAt])
  @@index([isActive])
  @@index([geminiConfigModelId])
}

// Model UserAIConversation (Lịch sử hội thoại AI Kaiwa)
model UserAIConversation {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  conversationId String  @db.VarChar(100) // ID để group các messages trong cùng 1 conversation
  role           String  @db.VarChar(20) // USER hoặc AI
  message        String  @db.Text // Nội dung tin nhắn
  audioUrl       String? @db.VarChar(1000) // URL file audio (nếu có, cho AI response)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([conversationId])
  @@index([createdAt])
  @@index([deletedAt])
}

// Model AIConversationRoom (Phòng hội thoại AI - quản lý conversationId theo user)
model AIConversationRoom {
  id     String @id @default(cuid())
  userId Int
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // conversationId dùng cho websocket và để nhóm message
  conversationId String @unique @db.VarChar(100)

  // metadata hiển thị danh sách phòng
  title         String?   @db.VarChar(200)
  lastMessage   String?   @db.VarChar(500)
  lastMessageAt DateTime?
  isArchived    Boolean   @default(false)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([lastMessageAt])
  @@index([deletedAt])
}

model GeminiModel {
  id                Int                 @id @default(autoincrement())
  provider          String              @default("GEMINI") @db.VarChar(50)
  key               String              @unique @db.VarChar(100) // ví dụ: gemini-2.5-pro
  displayName       String              @db.VarChar(100)
  description       String?             @db.Text
  isEnabled         Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  GeminiConfigModel GeminiConfigModel[]
}

// System-level model cấu hình bởi hệ thống, tham chiếu tới GeminiModel (vendor)
model GeminiConfigModel {
  id            Int         @id @default(autoincrement())
  name          String      @db.VarChar(100) // Tên hiển thị cho FE
  geminiModelId Int
  geminiModel   GeminiModel @relation(fields: [geminiModelId], references: [id], onDelete: Restrict)

  // Tham số tuỳ chọn cho model
  maxTokens         Int?
  jsonMode          Boolean? @default(false)
  systemInstruction String?  @db.Text
  safetySettings    Json?
  extraParams       Json?

  // Tham chiếu preset cấu hình (ưu tiên presetId nếu có)
  presetId Int?
  preset   GeminiModelPreset? @relation(fields: [presetId], references: [id], onDelete: SetNull)

  isEnabled Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Audit (admin)
  createdById Int?
  createdBy   User?     @relation("GeminiConfigModelCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User?     @relation("GeminiConfigModelUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User?     @relation("GeminiConfigModelDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedAt   DateTime?

  // Quan hệ
  geminiConfigs GeminiConfig[]

  @@index([deletedAt])
  @@index([presetId])
}

// Lưu preset thông số cho Gemini model (áp dụng cho nhiều ConfigModel)
model GeminiModelPreset {
  id          Int     @id @default(autoincrement())
  key         String  @unique @db.VarChar(100)
  name        String  @db.VarChar(200)
  description String? @db.Text

  // Thông số cấu hình
  temperature Float?
  topP        Float?
  topK        Int?

  isEnabled Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Backlink
  configModels GeminiConfigModel[]
}

// Mapping service ↔ config: service chỉ dùng được config đã được gán
model GeminiServiceConfig {
  id             Int              @id @default(autoincrement())
  serviceType    GeminiConfigType
  geminiConfigId Int
  geminiConfig   GeminiConfig     @relation(fields: [geminiConfigId], references: [id], onDelete: Cascade)

  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceType, geminiConfigId])
}

enum RoleSpeaking {
  A
  B
}

enum RankName {
  N5
  N4
  N3
}

enum RewardClaimStatus {
  PENDING
  CLAIMED
  COMPLETED
}

enum UserRewardSourceType {
  REWARD_SERVICE // Qua RewardService.convertRewardsWithUser
  LESSON // Hoàn thành bài học / lesson-based reward
  DAILY_REQUEST // Hoàn thành Daily Request / Streak
  ATTENDANCE // Điểm danh (Attendance)
  SEASON_REWARD // Thưởng mùa giải (Leaderboard Season)
  ADMIN_ADJUST // Admin thưởng thủ công
  OTHER // Trường hợp khác
  ACHIEVEMENT_REWARD // Thưởng từ thành tích
}

enum UserAchievementStatus {
  IN_PROGRESS
  COMPLETED_NOT_CLAIMED
  CLAIMED
}
