generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int            @id @default(autoincrement())
  email              String         @unique @db.VarChar(500)
  name               String         @db.VarChar(500)
  password           String         @db.VarChar(500)
  phoneNumber        String         @db.VarChar(50)
  avatar             String?        @db.VarChar(1000)
  status             UserStatus     @default(INACTIVE)
  roleId             Int
  role               Role           @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  levelId            Int?
  level              Level?         @relation(fields: [levelId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  devices            Device[] // Liên kết 1-n với Device
  refreshTokens      RefreshToken[]
  createdPermissions Permission[]   @relation("PermissionCreatedBy")
  updatedPermissions Permission[]   @relation("PermissionUpdatedBy")
  deletedPermissions Permission[]   @relation("PermissionDeletedBy")
  createdRoles       Role[]         @relation("RoleCreatedBy")
  updatedRoles       Role[]         @relation("RoleUpdatedBy")
  deletedRoles       Role[]         @relation("RoleDeletedBy")
  createdLevels      Level[]        @relation("LevelCreatedBy")
  updatedLevels      Level[]        @relation("LevelUpdatedBy")
  deletedLevels      Level[]        @relation("LevelDeletedBy")
  createdRewards     Reward[]       @relation("RewardCreatedBy")
  updatedRewards     Reward[]       @relation("RewardUpdatedBy")
  deletedRewards     Reward[]       @relation("RewardDeletedBy")

  // 1 user có thể tạo ra nhiều user khác
  // 1 user chỉ có thể được tạo ra bởi 1 user khác
  // Tự quan hệ 1-n
  createdById  Int?
  createdBy    User?  @relation("CreatorUsers", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  createdUsers User[] @relation("CreatorUsers")

  updatedById  Int?
  updatedBy    User?  @relation("UpdatorUsers", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedUsers User[] @relation("UpdatorUsers")
  deletedById  Int?
  deletedBy    User?  @relation("DeletorUsers", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedUsers User[] @relation("DeletorUsers")

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model Device {
  id            Int            @id @default(autoincrement())
  userId        Int
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  deviceToken   String         @unique // UUID để định danh thiết bị
  userAgent     String
  ip            String
  lastActive    DateTime       @updatedAt // Thay updatedAt bằng lastActive cho ý nghĩa rõ hơn
  createdAt     DateTime       @default(now())
  isActive      Boolean        @default(true) // Trạng thái thiết bị (đang login hay đã logout)
  refreshTokens RefreshToken[] // Liên kết 1-n với RefreshToken
}

model RefreshToken {
  token     String   @unique @db.VarChar(1000)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  deviceId  Int // Foreign key tới Device
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
}

model Permission {
  id          Int        @id @default(autoincrement())
  name        String     @db.VarChar(500)
  description String     @default("")
  path        String     @db.VarChar(1000)
  method      HTTPMethod
  module      String     @default("") @db.VarChar(500)
  roles       Role[]

  createdById Int?
  createdBy   User? @relation("PermissionCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("PermissionUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("PermissionDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @db.VarChar(500)
  description String       @default("")
  isActive    Boolean      @default(true)
  permissions Permission[]
  users       User[]

  createdById Int?
  createdBy   User? @relation("RoleCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("RoleUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("RoleDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model Vocabulary {
  id        Int      @id @default(autoincrement())
  wordJp    String   @db.VarChar(500)
  reading   String   @db.VarChar(500)
  imageUrl  String?  @db.VarChar(1000)
  audioUrl  String?  @db.VarChar(1000)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([wordJp])
  @@index([reading])
}

model Reward {
  id           Int          @id @default(autoincrement())
  name         String
  rewardType   RewardType   @default(LESSON)
  rewardItem   Int
  rewardTarget RewardTarget @default(EXP)

  // Quan hệ với Level
  levels Level[]

  // Audit fields
  createdById Int?
  createdBy   User? @relation("RewardCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("RewardUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("RewardDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  // Timestamps
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Level {
  id Int @id @default(autoincrement())

  levelNumber Int
  requiredExp Int
  levelType   LevelType
  isDeleted   Boolean   @default(false)

  // Self relation: next level
  nextLevelId Int?
  nextLevel   Level?  @relation("NextLevel", fields: [nextLevelId], references: [id])
  prevLevels  Level[] @relation("NextLevel")

  // Reward relation
  rewardId Int?
  reward   Reward? @relation(fields: [rewardId], references: [id])

  users User[]

  createdById Int?
  createdBy   User? @relation("LevelCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("LevelUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("LevelDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

enum VerificationCodeType {
  REGISTER
  FORGOT_PASSWORD
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum HTTPMethod {
  GET
  POST
  PUT
  DELETE
  PATCH
  OPTIONS
  HEAD
}

enum MediaType {
  IMAGE
  VIDEO
}

enum LevelType {
  USER
  POKEMON
}

enum RewardType {
  LESSON
  DAILY_REQUEST
  EVENT
  ACHIEVEMENT
  LEVEL
}

enum RewardTarget {
  EXP
  POINT
  POKEMON
  BADGE
  VOUCHER
}
